<!doctype html>
<html>
<head>
    <link rel="icon" href='images/icon.png'/>
    <title>My fancy game</title>
</head>
<body>
<canvas id="canvas" style="border:1px solid #000"></canvas>
 
<script>
    (function() {
    var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
    window.requestAnimationFrame = requestAnimationFrame;
})();
    
    document.getElementById('canvas').style.backgroundImage = "url('images/walk/background.jpg')";
    
    var backAudio = new Audio('audio/backMusic.mp3');
    backAudio.loop = true;
    
    backAudio.play();
    var jumpAudio = new Audio('audio/jump.wav');
    var eatAudio = new Audio('audio/eat.wav');
 
var canvas = document.getElementById("canvas"),
    ctx = canvas.getContext("2d"),
    width = 1135,
    height = 568,
    player = {
      x : width/2,
      y : height - 50,
      width : 40,
      height : 50,
      speed: 3,
      velX: 0,
      velY: 0,
      jumping: false,
      mirror: true
    },
	
	
    keys = [],
    friction = 0.85,
    gravity = 0.4;
    
	var offset = 0;
	
	var counter = 0;
	
    var boxes = [];

    var fish = [];
    var fishScore = 0;

    //adding boxes--------------------------------------------------------------

    var d = new Date();

    var lastTime = d.getTime();
    var thisTime = d.getTime();
    var delta = 0;


    // dimensions
    boxes.push({
        x: width/2 + 50,
        y: height - 200,
        width: 198,
        height: 38
    });

	boxes.push({
        x: width/2 + 250,
        y: height - 300,
        width: 198,
        height: 38
    });
    boxes.push({
        x: width/2 - 100,
        y: height - 400,
        width: 198,
        height: 38
    });
    boxes.push({
        x: width/2 - 250,
        y: height - 480,
        width: 198,
        height: 38
    });

    //-----------------------------------------------------------------------





    //adding fishes----------------------------------------------------------
    addFish(width/2 + 100, height - 240);
    addFish(200, 200);
    //-----------------------------------------------------------------------

    function addFish(x, y) {
        fish.push({
            x: x,
            y: y,
            width: 40,
            height: 25,
            active: true
        });
    }

		var walkRightImg = new Image();
		walkRightImg.src = 'images/walk/walkRightSprite.png';
		
		var walkLeftImg = new Image();
		walkLeftImg.src = 'images/walk/walkLeftSprite.png';
		
        var move = new Array();
        var moveMirror = new Array();
        var numOfSpritesMove = 4;
        for(var i = 0; i < numOfSpritesMove; i++){
            move[i] = new Image();
            move[i].src = 'images/walk/'.concat(i + 1).concat('.png');
            moveMirror[i] = new Image();
            moveMirror[i].src = 'images/walk/'.concat(i + 1).concat('mirror.png');
        }
        var block = new Image();
        block.src = 'images/walk/block.png';

        var fishImage = new Image();
        fishImage.src = 'images/walk/fishSmall.png';

    canvas.width = width;
    canvas.height = height;
	
	function render()
	{
		ctx.clearRect(0,0,width,height);
        ctx.save();
        drawBoxes();
		
        //drawMirroredCharacter();
        if(player.mirror){
            //drawCharacter();
            walkRight();
        } else {
            //drawMirroredCharacter();
            walkLeft();
        }

        ctx.font="20px Verdana";
        ctx.fillText("Score: " + fishScore, 20, 20);
		
	}
    
    function drawBoxes(){
        for (var i = 0; i < boxes.length; i++) {
            ctx.drawImage(block,  0, 0, 198, 38,  boxes[i].x - offset, boxes[i].y, boxes[i].width, boxes[i].height);
            }

        for (var i = 0; i < fish.length; i++) {
            if(fish[i].active)
            ctx.drawImage(fishImage,  0, 0, 40, 29, fish[i].x - offset, fish[i].y, fish[i].width, fish[i].height);
        }
    }

    function drawCharacter(){
        ctx.drawImage(move[3], player.x, player.y, player.width, player.height);
    }

	function drawMirroredCharacter(){
        ctx.drawImage(moveMirror[0], player.x, player.y, player.width, player.height);
    }
    
	function updateSprites()
	{   
        if(player.spriteUpdates && !player.jumping) {
            player.spriteSinceLastUpdate += delta;
            if (player.spriteSinceLastUpdate > 125) {
                player.spriteSinceLastUpdate -= 125;
                player.spriteFrame++;
            }
        }
        else {
                player.spriteSinceLastUpdate = 99;
                player.spriteFrame = 0;
            }
	}
    

    function walkRight(){
        ctx.drawImage(walkRightImg, 101*(player.spriteFrame%4), 0, 101, 115, player.x, player.y, player.width, player.height);
    }

    function walkLeft(){
        ctx.drawImage(walkLeftImg, 101*(player.spriteFrame%4), 0, 101, 115, player.x, player.y, player.width, player.height);
    }
	
	function updateGameWorld()
	{
		player.velX *= friction;

		if(player.jumping)
        player.velY += gravity;
		
		
        player.x += player.velX;
        player.y += player.velY;

		
		if (player.x >= width - player.width) {
            player.x = width - player.width;
        } else if (player.x <= 0) {         
            player.x = 0;
        }



        player.jumping = true;

		for (var i = 0; i < boxes.length; i++) {
			var vecX = (player.x + (player.width / 2)) - (boxes[i].x - offset + (boxes[i].width / 2));
			var vecY = (player.y + (player.height / 2)) - (boxes[i].y + (boxes[i].height / 2));
			
			var hHeight = (player.height + boxes[i].height)/2;
			var hWidth= (player.width + boxes[i].width)/2;
			
			if (Math.abs(vecX) < hWidth && Math.abs(vecY) < hHeight) {         // figures out on which side we are colliding (top, bottom, left, or right)         var oX = hWidths - Math.abs(vX),             oY = hHeights - Math.abs(vY);         if (oX >= oY) {
				var oX = hWidth - Math.abs(vecX),             
					oY = hHeight - Math.abs(vecY);         
				if (oX >= oY) {
					if (vecY > 0) { // top

						player.y += oY;
						player.velY = 0;
					} else { // bottom

						player.jumping = false;
						player.y -= oY-1;
						player.velY = 0;
					}
				} else { 
			
					if (vecX > 0) {// left
						
						player.x += oX;
						player.velX = 0;
					} else { // right
					
						player.x -= oX;
						player.velX = 0;
					}
				}
			}
		}

		for(var i = 0; i < fish.length; i++) {
            if (fish[i].active) {
                var fishVecX = (player.x + (player.width / 2)) - (fish[i].x - offset + (fish[i].width / 2));
                var fishVecY = (player.y + (player.height / 2)) - (fish[i].y + (fish[i].height / 2));

                var fishHHeight = (player.height + fish[i].height) / 2;
                var fishHWidth = (player.width + fish[i].width) / 2;

                if (Math.abs(fishVecX) < fishHWidth && Math.abs(fishVecY) < fishHHeight) {
                    fish[i].active = false;
                    eatAudio.play();
                    fishScore++;
                }
            }
        }
		
		if(player.y >= height - player.height - 130){
            player.y = height - player.height - 130;
            player.jumping = false;
        }

		if(player.x >= width*2/3)
		{
			offset += player.x - width*2/3;
			player.x = width*2/3;
		} else if(player.x < width*1/3)
		{
			offset += player.x - width*1/3;
			player.x = width*1/3;
		}


	}
	
	function updateControls()
	{


        player.spriteUpdates = false;

        if (keys[39]) {
            // right arrow
            if (player.velX < player.speed) {             
                player.velX++; 
                player.mirror = true;
//                walkRight();
//                counter++;
             }
             player.spriteUpdates = true;

        }     
        if (keys[37]) {         
            // left arrow         
            if (player.velX > -player.speed) {
                player.velX--;
                player.mirror = false;
            }
            player.spriteUpdates = true;
        }

        if (keys[38] || keys[32]) {
            // up arrow or space
            if(!player.jumping){
                player.jumping = true;
                player.velY = -player.speed*4;
                jumpAudio.play();
            }
        }
	}
	
    function update(){
      // check keys
        lastTime = thisTime;

        counter++;

        updateControls();
		updateGameWorld();
		updateSprites();
		render();
        
        requestAnimationFrame(update);
        d = new Date();
        thisTime = d.getTime();
        delta = thisTime - lastTime;
    }
    //setup event listeners
    document.body.addEventListener("keydown", function(e) {
        keys[e.keyCode] = true;
    });
    document.body.addEventListener("keyup", function(e) {
        keys[e.keyCode] = false;
    });
    //instead window.onload
    window.addEventListener("load",function(){
        d = new Date();
        thisTime = lastTime = d.getTime();
        update();


    });
    
</script>
</body>
</html>